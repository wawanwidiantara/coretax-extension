// === download-manager.js (Versi SINKRONISASI FOLDER LOKAL + AUTO-CLOSE) ===
document.addEventListener('DOMContentLoaded', () => {

  // --- GANTI FUNGSI LAMA DENGAN VERSI BARU INI ---
  function extractNoPajak(filename) {
    if (!filename) return 'N/A';
    
    // Pola 1: Format standar (cth: 010.001-23.00000123)
    let match = filename.match(/(\d{3}\.\d{3}-\d{2}\.\d{8})/);
    if (match) return match[1];

    // Pola 2: Format rename (cth: 010_001-23_00000123)
    match = filename.match(/(\d{3}_\d{3}-\d{2}_\d{8})/);
    if (match) return match[1];

    // --- PERBAIKAN: Pola 3 BARU untuk Retur Pajak Masukan (input-return) ---
    // Sangat spesifik, dicari sebelum pola e-Faktur.
    // Mencari -(RET...)-16digit.pdf dari akhir file
    match = filename.match(/-(RET[a-zA-Z0-9]+)-\d{16}\.pdf$/i);
    if (match) return match[1]; // Mengambil grup (RET....)

    // Pola 4: Format file download asli e-Faktur (mencari dari akhir)
    // Mencari -(16digit)-16digit.pdf dari akhir file
    match = filename.match(/(\d{16})-\d{16}\.pdf$/i); 
    if (match) return match[1]; // Mengambil grup (16digit) pertama
    
    // Pola 5: BARU untuk BPU ISSUED
    // Mencari _BPU_(kode...)
    match = filename.match(/_BPU_([a-zA-Z0-9]+)/i);
    if (match) return match[1];
    
    // Pola 6: Mencari nomor Bupot Unifikasi (angka panjang di AWAL file)
    match = filename.match(/^(\d{10,})/); 
    if (match) return match[1];

    // (Pola 'RET' fallback yang lama sudah dihapus karena diganti Pola 3 yang lebih spesifik)
    
    return 'N/A';
  }
  // --- AKHIR FUNGSI BARU ---


  initializeDownloadManager();

  // localBlobMap akan menyimpan File object. 
  // Key: filename (dari latestFiles), Value: File object (dari lokal)
  const localBlobMap = {}; 

  function updateFailedCountHeader(count) {
    const span = document.getElementById('failedCount');
    if (span) {
      span.textContent = count > 0 ? `‚Äì ${count} gagal` : '';
    }
  }

  function initializeDownloadManager() {
    const fileList = document.getElementById('fileList');
    const mergeBtn = document.getElementById('mergeBtn');
    const clearBtn = document.getElementById('clearFilesBtn');
    const downloadSummary = document.getElementById('downloadSummary');
    const hideFailedCheckbox = document.getElementById('hideFailedCheckbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    
    // Tombol Upload Manual
    const uploadBtn = document.getElementById('uploadLocalBtn');
    const uploadInput = document.getElementById('uploadLocalInput');
    
    // Tombol Sinkronisasi Folder (BARU)
    const syncFolderBtn = document.getElementById('syncFolderBtn');
    const syncFolderInput = document.getElementById('syncFolderInput');

    let latestFiles = []; // Ini HANYA akan menampung file dari storage
    let failedFiles = [];

    if (typeof PDFLib === 'undefined') {
      console.error('PDFLib tidak tersedia. Pastikan pdf-lib.min.js sudah dimuat.');
      if (mergeBtn) mergeBtn.disabled = true;
    }

    // --- FUNGSI UPLOAD MANUAL ---
    uploadBtn.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (!files.length) return;

      const newEntries = [];
      for (const file of files) {
        // Cek duplikat
        if (latestFiles.some(f => f.filename === file.name)) continue;

        const newEntry = {
          filename: file.name,
          url: URL.createObjectURL(file), // Buat URL blob dummy
          isManual: true // Tandai sebagai manual
        };
        
        localBlobMap[file.name] = file; // Simpan File object
        newEntries.push(newEntry);
      }
      
      latestFiles = [...latestFiles, ...newEntries];
      updateUI(latestFiles);
      
      uploadInput.value = '';
    });
    
    // --- FUNGSI SINKRONISASI FOLDER (BARU) ---
    syncFolderBtn.addEventListener('click', () => syncFolderInput.click());
    syncFolderInput.addEventListener('change', (e) => {
        searchAndMatchFiles(Array.from(e.target.files));
    });
    
    function searchAndMatchFiles(localFiles) {
        let matchCount = 0;
        const expectedFiles = latestFiles.filter(f => !f.isManual); // Hanya cari file dari storage

        localFiles.forEach(localFile => {
            const localNoPajak = extractNoPajak(localFile.name);
            if (localNoPajak === 'N/A') return;

            // Cari file di 'latestFiles' yang noPajak-nya sama
            const expectedFile = expectedFiles.find(f => {
                const expectedNoPajak = extractNoPajak(f.filename);
                return expectedNoPajak !== 'N/A' && expectedNoPajak === localNoPajak;
            });

            if (expectedFile && !localBlobMap[expectedFile.filename]) {
                localBlobMap[expectedFile.filename] = localFile; // Simpan File object-nya
                matchCount++;
            }
        });

        if (matchCount > 0) {
            showNotification(`${matchCount} file berhasil disinkronkan!`, 'success');
            updateUI(latestFiles); // Render ulang UI untuk tunjukkan status "Ditemukan"
        } else {
            showNotification(`Tidak ada file baru yang cocok ditemukan di folder.`, 'info');
        }
        syncFolderInput.value = ''; // Kosongkan input
    }


    // --- Muat file dari storage saat inisialisasi ---
    function loadFilesFromStorage() {
      chrome.storage.local.get('latestDownloadedFiles', (result) => {
        // Bersihkan file non-manual
        latestFiles = latestFiles.filter(f => f.isManual);
        
        const storedFiles = result.latestDownloadedFiles || [];
        const storedFilenames = new Set(storedFiles.map(f => f.filename));
        
        // Gabungkan
        const manualOnlyFiles = latestFiles.filter(f => !storedFilenames.has(f.filename));
        latestFiles = [...storedFiles, ...manualOnlyFiles];
        
        updateUI(latestFiles);
        
        // Beri info jika harus sinkronisasi
        if (storedFiles.length > 0) {
            showNotification('Daftar file dimuat. Klik "Sinkronkan Folder" untuk mencari file lokal.', 'info');
        }
      });
    }
    
    loadFilesFromStorage();

    // --- Listener untuk file baru (jika ada unduhan saat tab ini terbuka) ---
    chrome.storage.onChanged.addListener((changes, area) => {
      if (area === 'local' && changes.latestDownloadedFiles) {
        loadFilesFromStorage(); // Muat ulang semua
      }
    });

    // --- MODIFIKASI: updateUI diperbarui ---
    function updateUI(files) {
      if (!fileList) return;

      if (files.length === 0) {
        if (downloadSummary) {
          downloadSummary.textContent = '';
          const p1 = document.createElement('p');
          p1.textContent = 'Silahkan unduh file dari Coretax, atau:';
          const p2 = document.createElement('p');
          p2.textContent = 'Gunakan tombol "Tambah File Manual" untuk memilih file dari komputer Anda.';
          downloadSummary.appendChild(p1);
          downloadSummary.appendChild(p2);
        }
        if (fileList) {
          fileList.innerHTML = '';
          const div = document.createElement('div');
          div.className = 'no-files';
          div.textContent = 'Belum ada file dalam daftar.';
          fileList.appendChild(div);
        }
        
        if (mergeBtn) mergeBtn.disabled = true;
        if (clearBtn) clearBtn.disabled = true;
        updateFailedCountHeader(0);
        return;
      }
      
      // Hitung status
      let matchedCount = 0;
      files.forEach(f => {
          if (localBlobMap[f.filename]) matchedCount++;
      });

      if (downloadSummary) {
        downloadSummary.innerHTML = ''; // Ganti ke innerHTML
        const p1 = document.createElement('p');
        p1.innerHTML = `<strong>Total ${files.length} file dalam daftar.</strong>`;
        
        const p2 = document.createElement('p');
        p2.innerHTML = `
            <span style="color: #28a745; font-weight: bold;">${matchedCount} Ditemukan (Lokal)</span> / 
            <span style="color: #f8961e; font-weight: bold;">${files.length - matchedCount} Menunggu Sinkronisasi</span>
        `;
        downloadSummary.appendChild(p1);
        downloadSummary.appendChild(p2);
      }

      fileList.innerHTML = '';

      files.forEach((file, index) => {
        const filename = file.filename || file;
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.setAttribute('data-filename', filename);
        fileItem.setAttribute('data-index', index);

        const noPajak = extractNoPajak(filename); 
        
        // Cek Status File
        const isMatched = !!localBlobMap[filename];
        const isManual = !!file.isManual;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isMatched; // Otomatis centang jika file ditemukan
        checkbox.id = `file-${index}`;
        checkbox.className = 'file-checkbox';

        const controls = document.createElement('div');
        controls.style.display = "flex";
        controls.style.flexDirection = "column";
        controls.style.gap = "2px";
        controls.style.marginRight = "10px";
        controls.style.marginTop = "2px"; 

        const upBtn = document.createElement('button');
        upBtn.textContent = '‚¨Ü';
        upBtn.title = 'Geser ke atas';
        upBtn.style.width = '30px';
        upBtn.style.height = '25px';
        upBtn.style.fontSize = '12px';
        upBtn.onclick = () => {
          if (index > 0) {
            [latestFiles[index - 1], latestFiles[index]] = [latestFiles[index], latestFiles[index - 1]];
            if (Object.keys(localBlobMap).length === 0) {
              chrome.storage.local.set({ latestDownloadedFiles: latestFiles });
            } else {
              updateUI(latestFiles); 
            }
          }
        };

        const downBtn = document.createElement('button');
        downBtn.textContent = '‚¨á';
        downBtn.title = 'Geser ke bawah';
        downBtn.style.width = '30px';
        downBtn.style.height = '25px';
        downBtn.style.fontSize = '12px';
        downBtn.onclick = () => {
          if (index < latestFiles.length - 1) {
            [latestFiles[index], latestFiles[index + 1]] = [latestFiles[index + 1], latestFiles[index]];
             if (Object.keys(localBlobMap).length === 0) {
              chrome.storage.local.set({ latestDownloadedFiles: latestFiles });
            } else {
              updateUI(latestFiles); 
            }
          }
        };

        controls.appendChild(upBtn);
        controls.appendChild(downBtn);
        
        fileItem.appendChild(controls);
        fileItem.appendChild(checkbox);

        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';

        // Tentukan status path
        let pathText = '';
        let pathClass = '';
        if (isManual) {
            pathText = 'üìÅ File Manual';
            pathClass = 'manual';
        } else if (isMatched) {
            pathText = '‚úÖ Ditemukan (Lokal)';
            pathClass = 'matched';
        } else {
            pathText = '‚ö†Ô∏è Menunggu Sinkronisasi';
            pathClass = 'waiting';
        }

        fileInfo.innerHTML = `
          <div class="file-details">
            <div class="file-nopajak">No. Pajak: <strong>${noPajak}</strong></div>
            <div class="file-name">${filename}</div>
          </div>
          <div class="file-path ${pathClass}">
            ${pathText}
          </div>
        `;

        fileItem.appendChild(fileInfo);
        fileList.appendChild(fileItem);
      });

      if (mergeBtn) mergeBtn.disabled = (matchedCount === 0); // Hanya enable jika ada file lokal
      if (clearBtn) clearBtn.disabled = false;
      updateFailedCountHeader(failedFiles.length);
    }
    
    // --- MODIFIKASI: Tombol Clear ---
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (confirm("Apakah Anda yakin ingin menghapus semua file dari daftar?")) {
          latestFiles = [];
          failedFiles = [];
          Object.keys(localBlobMap).forEach(key => delete localBlobMap[key]);
          
          chrome.storage.local.set({ latestDownloadedFiles: [] }, () => {
            updateUI([]);
            updateFailedCountHeader(0);
            showNotification('Daftar file telah dibersihkan.', 'success');
          });
        }
      });
    }

    if (hideFailedCheckbox) {
      hideFailedCheckbox.addEventListener('change', () => {
        const failedItems = document.querySelectorAll('.file-item.file-failed');
        failedItems.forEach(item => {
          item.style.display = hideFailedCheckbox.checked ? 'none' : 'flex';
        });
      });
    }

    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
          if (checkbox.closest('.file-item').style.display !== 'none') {
            checkbox.checked = true;
          }
        });
      });
    }

    // --- MODIFIKASI: Logika Tombol Gabungkan ---
    if (mergeBtn) {
      mergeBtn.addEventListener('click', async () => {
        if (typeof PDFLib === 'undefined') {
          alert('PDFLib tidak tersedia. Tidak dapat menggabungkan PDF.');
          return;
        }

        const selectedIndexes = Array.from(document.querySelectorAll('.file-checkbox:checked'))
          .map(checkbox => parseInt(checkbox.closest('.file-item').getAttribute('data-index')));
          
        const selectedFiles = selectedIndexes.map(i => latestFiles[i]).filter(Boolean);
        
        // PENTING: Filter lagi HANYA file yang sudah ditemukan lokal
        const filesToMerge = selectedFiles.filter(f => localBlobMap[f.filename]);

        if (filesToMerge.length === 0) {
          alert('Pilih setidaknya satu file yang sudah ditemukan (Lokal) untuk digabungkan.');
          return;
        }

        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressContainer = document.getElementById('progressContainer');
        const etaText = document.getElementById('etaText');
        const currentFileText = document.getElementById('currentFile');
        const timeStats = document.getElementById('timeStats');

        if (progressBar) progressBar.style.width = '0%';
        if (progressText) progressText.textContent = '0%';
        if (etaText) etaText.textContent = '';
        if (currentFileText) currentFileText.textContent = '';
        if (progressContainer) progressContainer.style.display = 'block';

        mergeBtn.disabled = true;
        if (clearBtn) clearBtn.disabled = true;
        failedFiles = [];

        try {
          const mergedPdf = await PDFLib.PDFDocument.create();
          const total = filesToMerge.length;
          const startTime = Date.now();
          const startTimeStr = new Date().toLocaleTimeString();
          if (timeStats) timeStats.textContent = `‚è±Ô∏è Mulai: ${startTimeStr}`;


          for (let i = 0; i < total; i++) {
            const file = filesToMerge[i]; // Ambil dari filesToMerge
            const percent = Math.round(((i + 1) / total) * 100);
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressText) progressText.textContent = `${percent}%`;
            if (currentFileText) currentFileText.textContent = `Sedang memproses: ${file.filename}`;

            const elapsed = (Date.now() - startTime) / 1000;
            const estimatedTotal = (elapsed / (i + 1)) * total;
            const remaining = Math.max(0, estimatedTotal - elapsed);
            if (etaText) etaText.textContent = `Estimasi selesai: ${remaining.toFixed(1)} detik lagi`;

            try {
              // PENTING: Ambil dari fetchArrayBuffer
              const arrayBuffer = await fetchArrayBuffer(file);
              const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
              const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
              copiedPages.forEach(page => mergedPdf.addPage(page));
            } catch (error) {
              console.error(`Gagal memproses file ${file.filename}:`, error);
              markFileAsFailed(file.filename, 'Gagal memuat file');
              failedFiles.push({ filename: file.filename, reason: 'Gagal memuat file' });
            }
            
            await new Promise(resolve => setTimeout(resolve, 100)); 
          }

          const mergedPdfBytes = await mergedPdf.save();
          const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
          const blobUrl = URL.createObjectURL(blob);

          chrome.downloads.download({
            url: blobUrl,
            filename: 'Gabungan_Coretax.pdf',
            saveAs: true 
          }, (downloadId) => {
            setTimeout(() => URL.revokeObjectURL(blobUrl), 5000); 

            if (chrome.runtime.lastError) {
              console.error(`Gagal memulai download: ${chrome.runtime.lastError.message}`);
              alert("Gagal membuka dialog 'Save As'. File akan diunduh otomatis.");
              const link = document.createElement('a');
              link.href = blobUrl;
              link.download = 'Gabungan_Coretax.pdf';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
            } else if (downloadId === undefined) {
              console.log("Pengguna membatalkan dialog 'Save As'.");
              URL.revokeObjectURL(blobUrl);
            } else {
              console.log(`Download "Save As" dimulai dengan ID: ${downloadId}`);
            }
          });

          // --- Bagian Cleanup ---
          const failedFilenames = new Set(failedFiles.map(f => f.filename));
          latestFiles = latestFiles.filter(file => !failedFilenames.has(file.filename));
          
          const newStoredFiles = latestFiles.filter(f => !localBlobMap[f.filename]);
          chrome.storage.local.set({ latestDownloadedFiles: newStoredFiles });
          
          updateUI(latestFiles); 

          if (progressText) progressText.textContent = `Selesai!`;
          if (etaText) etaText.textContent = '';
          if (currentFileText) currentFileText.textContent = '';
          if (timeStats) timeStats.textContent += ` | Selesai: ${new Date().toLocaleTimeString()}`;
          updateFailedCountHeader(failedFiles.length);
          
          
          // --- KODE AUTO-CLOSE YANG DITAMBAHKAN ---
          // Beri jeda 1.5 detik agar status "Selesai!" terlihat
          setTimeout(() => {
              chrome.tabs.getCurrent((tab) => {
                  // Perintah untuk menutup tab ini
                  if (tab && tab.id) {
                      chrome.tabs.remove(tab.id);
                  } else {
                      window.close(); // Fallback jika tidak dapat ID tab
                  }
              });
          }, 1500); // Jeda 1500 milidetik (1.5 detik)
          // --- AKHIR KODE AUTO-CLOSE ---


        } catch (err) {
          console.error('Gagal menggabungkan PDF:', err);
          alert('Terjadi kesalahan saat menggabungkan PDF: ' + err.message);
        } finally {
          mergeBtn.disabled = false;
          if (clearBtn) clearBtn.disabled = false;
        }
      });
    }

    // --- MODIFIKASI: fetchArrayBuffer ---
    // Sekarang WAJIB mengambil dari localBlobMap
    async function fetchArrayBuffer(file) {
      if (localBlobMap[file.filename]) {
        // localBlobMap[file.filename] adalah File object
        return localBlobMap[file.filename].arrayBuffer();
      }
      
      // Jika file (dari storage) tidak ditemukan di map, lempar error.
      // Kita tidak mau fetch URL Coretax yang gagal.
      throw new Error(`File ${file.filename} tidak ditemukan di folder lokal. Silakan sinkronkan.`);
    }

    function markFileAsFailed(filename, reason = 'Gagal fetch') {
      const allItems = document.querySelectorAll('.file-item');
      allItems.forEach(item => {
        if (item.getAttribute('data-filename') === filename) {
          item.classList.add('file-failed');
          const info = item.querySelector('.file-info');
          if (info && !info.querySelector('.error-label')) {
            const errorLabel = document.createElement('div');
            errorLabel.className = 'error-label';
            errorLabel.style.color = 'red';
            errorLabel.style.fontSize = '0.85em';
            errorLabel.style.marginTop = '5px';
            errorLabel.textContent = `‚ö†Ô∏è ${reason}`;
            info.appendChild(errorLabel);
          }
        }
      });
    }
  }
});

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3'};
    color: white;
    border-radius: 5px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-width: 300px;
  `;
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
}

window.addEventListener('error', (event) => {
  console.error('Error global:', event.error);
  showNotification('Terjadi kesalahan dalam aplikasi', 'error');
});