// === popup.js (Updated for Chrome & Manifest V3) ===

document.addEventListener('DOMContentLoaded', () => {
  const exportBtn = document.getElementById("exportBtn");
  const excelExportBtn = document.getElementById("excelExportBtn");
  const bupotBtn = document.getElementById("Bupot");

  // Helper function to execute a function in the active tab
  function executeFunctionInTab(tabId, funcToExecute) {
    chrome.scripting.executeScript({
      target: { tabId: tabId },
      function: funcToExecute
    });
  }

  if (exportBtn) {
    exportBtn.addEventListener("click", async () => {
      try {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

        if (tab.url.includes('https://coretaxdjp.pajak.go.id/registration-portal/id-ID/documents')) {
          executeFunctionInTab(tab.id, downloadBupotDocuments);
        } else {
          executeFunctionInTab(tab.id, extractAndDownloadData);
        }
      } catch (error) {
        console.error("Gagal menjalankan skrip PDF:", error);
      }
    });
  }

  if (excelExportBtn) {
    excelExportBtn.addEventListener("click", async () => {
      try {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        executeFunctionInTab(tab.id, extractAndDownloadData2);
      } catch (error) {
        console.error("Gagal menjalankan skrip CSV:", error);
      }
    });
  }

  if (bupotBtn) {
    bupotBtn.addEventListener("click", async () => {
      try {
        const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tab.url.includes('coretaxdjp.pajak.go.id')) {
          // content.js is auto-injected by manifest, so just send a message
          chrome.tabs.sendMessage(tab.id, { action: "downloadBupot" });
        } else {
          alert('Buka situs Coretax DJP terlebih dahulu.');
        }
      } catch (error) {
        console.error("Gagal menjalankan skrip Bupot:", error);
      }
    });
  }
});

chrome.runtime.onMessage.addListener(async (message, sender, sendResponse) => {
  if (message.action === "openDownloadManagerPage") {
    try {
      const url = chrome.runtime.getURL("download-manager.html");
      await chrome.tabs.create({ url });
      return { status: "success" };
    } catch (error) {
      console.error("Gagal membuka download-manager.html:", error);
      return { status: "error", error: error.message };
    }
  }
  return true;
});


// THESE FUNCTIONS ARE SENT TO THE CONTENT SCRIPT TO BE EXECUTED
// No changes needed here, as they are executed in the page's context.

async function downloadBupotDocuments() {
  console.log("Menjalankan fungsi khusus untuk halaman Documents...");
  const selectedData = [];
  const delay = 1000;
  const headers = ["No", "Jenis Dokumen", "Masa Pajak", "Tahun Pajak", "Nomor Dokumen", "Tanggal Dokumen", "Status"];
  selectedData.push(headers);
  const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
  if (checkboxes.length === 0) {
    alert("Pilih setidaknya satu bukti potong untuk didownload.");
    return;
  }
  let successCount = 0;
  let failedList = [];
  for (let index = 0; index < checkboxes.length; index++) {
    const checkbox = checkboxes[index];
    const row = checkbox.closest('tr');
    if (!row) continue;
    const cells = row.querySelectorAll('td');
    const rowData = [];
    for (let i = 0; i < Math.min(cells.length, 7); i++) {
      let text = cells[i]?.innerText.trim() || '';
      if ([3, 4].includes(i)) {
        text = text.replace(/\./g, '');
      }
      rowData.push(text);
    }
    selectedData.push(rowData);
    const downloadButton = row.querySelector('button#DownloadButton, a[href*="download"], button[onclick*="download"]');
    if (downloadButton) {
      try {
        downloadButton.click();
        successCount++;
        await new Promise(resolve => setTimeout(resolve, delay));
      } catch (error) {
        console.error(`Gagal download untuk baris ${index + 1}:`, error);
        failedList.push(`Baris ${index + 1}`);
      }
    } else {
      failedList.push(`Baris ${index + 1} (tombol tidak ditemukan)`);
    }
  }
  if (selectedData.length > 1) {
    chrome.runtime.sendMessage({
      action: "downloadExcel",
      data: selectedData
    });
  }
  const showBupotNotification = (successCount, failedList) => {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;
      text-align: center; max-width: 400px;
    `;
    
    const title = document.createElement('h3');
    title.style.cssText = 'color: #28a745; margin-top: 0;';
    title.textContent = 'Download Selesai!';

    const successP = document.createElement('p');
    const strong = document.createElement('strong');
    strong.textContent = `${successCount} file`;
    successP.append('Berhasil didownload: ', strong);

    notification.appendChild(title);
    notification.appendChild(successP);

    if (failedList.length > 0) {
      const failedP = document.createElement('p');
      failedP.style.color = 'red';
      failedP.textContent = `Gagal: ${failedList.length} file`;
      notification.appendChild(failedP);
    }
    
    const closeBtn = document.createElement('button');
    closeBtn.id = 'closeBupotNotify';
    closeBtn.style.cssText = `
      background: #28a745; color: white; border: none; padding: 10px 20px;
      border-radius: 5px; cursor: pointer; margin-top: 15px;
    `;
    closeBtn.textContent = 'Tutup & Lihat Manager';
    notification.appendChild(closeBtn);
    
    document.body.appendChild(notification);
    
    document.getElementById('closeBupotNotify').addEventListener('click', () => {
      chrome.runtime.sendMessage({ action: "openDownloadManagerPage" });
      notification.remove();
    });
  };
  showBupotNotification(successCount, failedList);
}

async function extractAndDownloadData() {
    const selectedData = [];
    let tableContent = "";
    const delay = 1000;
    const headers = ["Referensi", "Tgl_Faktur", "No_Pajak", "NPWP_Pembeli", "Nama_Pembeli", "DPP", "DPPLain", "PPN", "Jumlah", "Masa", "Tahun", "Status"];
    selectedData.push(headers);
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    for (let index = 0; index < checkboxes.length; index++) {
        const checkbox = checkboxes[index];
        const row = checkbox.closest('tr');
        if (!row || row.querySelector('th')) continue;
        const cells = row.querySelectorAll('td');
        const rowData = [];
        const selectedColumns = [16, 6, 5, 2, 3, 11, 12, 13];
        let col11Value = 0, col13Value = 0;
        selectedColumns.forEach(index => {
            if (cells[index]) {
                let text = cells[index].innerText.trim();
                if ([11, 12, 13].includes(index)) text = text.replace(/\./g, '');
                if (index === 11) col11Value = parseInt(text) || 0;
                if (index === 13) col13Value = parseInt(text) || 0;
                rowData.push(text);
            }
        });
        const totalJumlah = col11Value + col13Value;
        rowData.push(totalJumlah);
        [7, 8, 9].forEach(index => {
            if (cells[index]) rowData.push(cells[index].innerText.trim());
        });
        selectedData.push(rowData);
        const ref = cells[cells.length - 3]?.innerText.trim().replace(/\.pdf$/i, '') || `data-${index}`;
        const col7 = cells[6]?.innerText.trim() || '';
        const col3 = cells[2]?.innerText.trim() || '';
        const col4 = cells[3]?.innerText.trim() || '';
        const col6 = cells[5]?.innerText.trim() || '';
        const col11 = parseFloat(cells[11]?.innerText.trim().replace(/\./g, '')) || 0;
        const col13 = parseFloat(cells[13]?.innerText.trim().replace(/\./g, '')) || 0;
        const sum = col11 + col13;
        const formattedCol11 = `Rp ${col11.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        const formattedCol13 = `Rp ${col13.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        const formattedSum = `Rp ${sum.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        const filename = `${ref} ${col7} ${col3} ${col4} ${col6} ${formattedCol11} ${formattedCol13} ${formattedSum}`;
        tableContent += `<tr><td>${ref}</td><td>${col7}</td><td>${col3}</td><td>${col4}</td><td>${col6}</td><td>${formattedCol11}</td><td>${formattedCol13}</td><td>${formattedSum}</td></tr>`;
        const button = row.querySelector('a[href]');
        if (button) {
            await new Promise(resolve => setTimeout(resolve, delay));
            chrome.runtime.sendMessage({
                action: "downloadFile",
                url: button.href,
                filename: `${filename}.pdf`
            });
        }
    }
    if (selectedData.length > 1) {
        chrome.runtime.sendMessage({ action: "downloadExcel", data: selectedData });
        chrome.runtime.sendMessage({ action: "saveTableContent", content: tableContent });
        setTimeout(() => {
            chrome.runtime.sendMessage({ action: "openDownloadManagerPage" });
        }, 2000);
    } else {
        alert("Pilih setidaknya satu baris untuk diekspor.");
    }
}

async function extractAndDownloadData2() {
    const selectedData = [];
    const headers = ["Referensi", "Tgl_Faktur", "No_Pajak", "NPWP_Pembeli", "Nama_Pembeli", "DPP", "DPPLain", "PPN", "Jumlah", "Masa", "Tahun", "Status"];
    selectedData.push(headers);
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    let tableContent = "";

    for (let index = 0; index < checkboxes.length; index++) {
        const checkbox = checkboxes[index];
        const row = checkbox.closest('tr');
        if (!row || row.querySelector('th')) continue;
        const cells = row.querySelectorAll('td');
        const rowData = [];
        const selectedColumns = [16, 6, 5, 2, 3, 11, 12, 13];
        let col11Value = 0, col13Value = 0;
        selectedColumns.forEach(index => {
            if (cells[index]) {
                let text = cells[index].innerText.trim();
                if ([11, 12, 13].includes(index)) text = text.replace(/\./g, '');
                if (index === 11) col11Value = parseInt(text) || 0;
                if (index === 13) col13Value = parseInt(text) || 0;
                rowData.push(text);
            }
        });
        const totalJumlah = col11Value + col13Value;
        rowData.push(totalJumlah);
        [7, 8, 9].forEach(index => {
            if (cells[index]) rowData.push(cells[index].innerText.trim());
        });
        selectedData.push(rowData);
        
        const ref = cells[cells.length - 3]?.innerText.trim().replace(/\.pdf$/i, '') || `data-${index}`;
        const col7 = cells[6]?.innerText.trim() || '';
        const col3 = cells[2]?.innerText.trim() || '';
        const col4 = cells[3]?.innerText.trim() || '';
        const col6 = cells[5]?.innerText.trim() || '';
        const col11 = parseFloat(cells[11]?.innerText.trim().replace(/\./g, '')) || 0;
        const col13 = parseFloat(cells[13]?.innerText.trim().replace(/\./g, '')) || 0;
        const sum = col11 + col13;
        const formattedCol11 = `Rp ${col11.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        const formattedCol13 = `Rp ${col13.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        const formattedSum = `Rp ${sum.toLocaleString('id-ID', { minimumFractionDigits: 2 })}`;
        tableContent += `<tr><td>${ref}</td><td>${col7}</td><td>${col3}</td><td>${col4}</td><td>${col6}</td><td>${formattedCol11}</td><td>${formattedCol13}</td><td>${formattedSum}</td></tr>`;
    }

    if (selectedData.length > 1) {
        chrome.runtime.sendMessage({ action: "downloadExcel", data: selectedData });
        chrome.runtime.sendMessage({ action: "saveTableContent", content: tableContent });
        setTimeout(() => {
            chrome.runtime.sendMessage({ action: "openDownloadManagerPage" });
        }, 2000);
    } else {
        alert("Pilih setidaknya satu baris untuk diekspor.");
    }
}