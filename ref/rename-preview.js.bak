// === rename-preview.js (FIX: Pencocokan Folder Manual + Auto) ===

document.addEventListener('DOMContentLoaded', () => {
    // --- Variabel & Elemen DOM ---
    const fileListContainer = document.getElementById('file-list-container');
    const saveBtn = document.getElementById('save-renamed-btn');
    const uploadFolderBtn = document.getElementById('upload-folder-btn');
    const folderInput = document.getElementById('folder-input');
    const selectSaveFolderBtn = document.getElementById('select-save-folder-btn');
    const clearSaveFolderBtn = document.getElementById('clear-save-folder-btn');
    const searchResults = document.getElementById('search-results');
    const selectedFolderInfo = document.getElementById('selected-folder-info');
    const defaultFolderInfo = document.getElementById('default-folder-info');
    const currentSaveFolder = document.getElementById('current-save-folder');
    const progressContainer = document.getElementById('progress-container');
    const progressText = document.getElementById('progress-text');
    const currentFileStatus = document.getElementById('current-file-status');
    const deleteOriginalFilesCheckbox = document.getElementById('delete-original-files');
    
    // --- Elemen Modal Popup ---
    const successModal = document.getElementById('success-modal');
    const modalMessage = document.getElementById('modal-message');
    const closeModalBtn = document.querySelector('.modal-close-btn');
    const modalOkBtn = document.getElementById('modal-ok-btn');

    // --- State Variables ---
    let initialPlan = [];
    let matchedFiles = {}; 
    let uploadedManualFiles = {};
    let selectedSaveFolderHandle = null;
    let uiUpdaterInterval = null; 

    // --- Penanganan Tombol & Event ---
    
    // 1. Tombol Upload Folder Sumber
    uploadFolderBtn.addEventListener('click', () => folderInput.click());
    
    // 2. Event saat user memilih folder/file
    folderInput.addEventListener('change', (event) => {
        const files = Array.from(event.target.files);
        searchResults.innerHTML = '<p>Mencari file yang cocok...</p>';
        
        // Jalankan logika pencarian baru
        const foundFiles = searchMatchingFiles(files);
        
        // Tampilkan hasil dan update state
        displaySearchResults(foundFiles);
        addManualFilesToFileList(foundFiles);
    });

    // 3. Tombol Pilih Folder Tujuan (FileSystem Access API)
    selectSaveFolderBtn.addEventListener('click', async () => {
        try {
            if ('showDirectoryPicker' in window) {
                const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
                selectedSaveFolderHandle = handle;
                currentSaveFolder.textContent = handle.name;
                selectedFolderInfo.style.display = 'block';
                defaultFolderInfo.style.display = 'none';
                clearSaveFolderBtn.style.display = 'inline-block';
            } else {
                alert('Browser Anda tidak mendukung pemilihan folder. File akan disimpan di folder default Downloads.');
            }
        } catch (error) { console.log('Pemilihan folder dibatalkan'); }
    });

    // 4. Tombol Reset Folder Tujuan
    clearSaveFolderBtn.addEventListener('click', () => {
        selectedSaveFolderHandle = null;
        selectedFolderInfo.style.display = 'none';
        defaultFolderInfo.style.display = 'block';
        clearSaveFolderBtn.style.display = 'none';
    });

    // --- Penanganan Modal ---
    function hideModal() { successModal.style.display = 'none'; }
    closeModalBtn.addEventListener('click', hideModal);
    modalOkBtn.addEventListener('click', hideModal);
    window.addEventListener('click', (event) => { if (event.target === successModal) hideModal(); });

    // ============================================================
    // [BAGIAN UTAMA] FUNGSI PENCARIAN & PENCOCOKAN (MANUAL UPLOAD)
    // ============================================================
    
    function searchMatchingFiles(files) {
        const foundFiles = [];
        
        files.forEach(file => {
            // 1. Bersihkan nama file yang diupload (hilangkan .pdf dan simbol aneh)
            // Contoh: "Faktur-010.000-22.00001234.pdf" -> "Faktur0100002200001234"
            const cleanFileName = file.name.replace(/\.pdf$/i, '').replace(/[^a-zA-Z0-9]/g, '');
            
            initialPlan.forEach(plan => {
                // 2. Tentukan kunci pencarian.
                // PRIORITAS: Gunakan 'matchId' (Nomor Pajak saja) yang dikirim dari content.js terbaru.
                // FALLBACK: Gunakan 'invoiceKey' (Gabungan No + Nama) untuk kompatibilitas lama.
                const keyToSearch = plan.matchId || plan.invoiceKey;
                
                // 3. Cek apakah nama file bersih MENGANDUNG kunci pencarian?
                // Jika keyToSearch="0100002200001234", maka nama file di atas akan COCOK.
                if (cleanFileName.includes(keyToSearch)) {
                    foundFiles.push({ 
                        file: file, 
                        plan: plan, 
                        filePath: file.webkitRelativePath || file.name 
                    });
                }
            });
        });
        return foundFiles;
    }

    function displaySearchResults(foundFiles) {
        if (foundFiles.length === 0) {
            searchResults.innerHTML = '<p style="color: #dc3545;">‚ùå Tidak ditemukan file yang cocok dengan daftar antrian.</p>';
            return;
        }
        let html = `<p style="color: #28a745;">‚úÖ Ditemukan ${foundFiles.length} file yang cocok.</p>`;
        foundFiles.forEach(found => {
            html += `<div style="background: #e8f5e8; padding: 8px; margin-top: 5px; border-radius: 4px; font-size: 13px;">
                <strong>Target: ${found.plan.newFilename}</strong><br>
                <span style="color: #555;">Sumber: ${found.filePath}</span>
            </div>`;
        });
        searchResults.innerHTML = html;
    }
    
    function addManualFilesToFileList(foundFiles) {
        foundFiles.forEach(found => {
            const fileKey = found.plan.invoiceKey;
            
            // Simpan data file manual ke state
            uploadedManualFiles[fileKey] = {
                fileObject: found.file,
                filename: found.file.name,
                filePath: found.filePath,
                url: URL.createObjectURL(found.file),
                isManualUpload: true
            };
            
            // Masukkan ke daftar file yang siap diproses
            matchedFiles[fileKey] = uploadedManualFiles[fileKey];
            
            // Update UI di Tabel
            const itemElement = document.getElementById(`item-${fileKey}`);
            if (itemElement) {
                const originalSpan = itemElement.querySelector('.original-filename');
                // Ubah teks menjadi nama file asli yang ditemukan
                originalSpan.textContent = `üìÅ ${found.file.name}`; 
                originalSpan.style.color = '#155724'; // Hijau tua
                originalSpan.style.fontWeight = 'bold';
                originalSpan.style.fontStyle = 'normal';
                
                // Ubah panah jadi ceklis
                const arrowCell = itemElement.querySelector('.arrow-cell');
                if(arrowCell) arrowCell.textContent = '‚úÖ';
            }
        });
        updateSaveButtonState();
    }
    
    function updateSaveButtonState() {
        const readyCount = Object.keys(matchedFiles).length;
        const totalCount = initialPlan.length;

        if (readyCount > 0) {
            saveBtn.disabled = false;
            if (readyCount === totalCount) {
                searchResults.innerHTML = `<p style="color: #28a745; font-weight:bold;">‚úÖ Semua file (${readyCount}/${totalCount}) siap diproses!</p>`;
            } else {
                 searchResults.innerHTML += `<p style="color: #f8961e; margin-top:5px;">‚ö†Ô∏è Siap diproses: ${readyCount} dari ${totalCount} file.</p>`;
            }
        } else {
            saveBtn.disabled = true;
        }
    }

    // ============================================================
    // [BAGIAN OTOMATIS] PEMANTAU DOWNLOAD DARI BROWSER
    // ============================================================
    const startUiUpdater = () => {
        uiUpdaterInterval = setInterval(() => { 
            chrome.storage.local.get('latestDownloadedFiles', (result) => {
                const downloadedFiles = result.latestDownloadedFiles || [];
                if (downloadedFiles.length === 0) return; 

                let hasChanged = false;
                let matchedCount = 0;

                // Logika Otomatis: Asumsi urutan download sesuai urutan tabel
                for (let i = 0; i < downloadedFiles.length; i++) {
                    if (i >= initialPlan.length) break; 
                    
                    const plan = initialPlan[i];
                    
                    // Jika file ini sudah di-upload manual, jangan timpa dengan auto download
                    if (matchedFiles[plan.invoiceKey]) {
                        matchedCount++;
                        continue; 
                    }
                    
                    const foundFile = downloadedFiles[i];
                    if (foundFile) {
                        hasChanged = true;
                        matchedFiles[plan.invoiceKey] = { ...foundFile, isManualUpload: false };
                        
                        // Update UI Tabel
                        const itemElement = document.getElementById(`item-${plan.invoiceKey}`);
                        if (itemElement) {
                            const originalSpan = itemElement.querySelector('.original-filename');
                            originalSpan.textContent = `‚¨áÔ∏è ${foundFile.filename.split(/[/\\]/).pop()}`;
                            originalSpan.style.color = '#333';
                            originalSpan.style.fontStyle = 'normal';
                        }
                        matchedCount++;
                    }
                }
                
                if(hasChanged) updateSaveButtonState();
                
                // Jika semua sudah match (baik manual atau auto), hentikan interval
                if (matchedCount === initialPlan.length) {
                    clearInterval(uiUpdaterInterval);
                }
            });
        }, 1500);
    };

    // ============================================================
    // [INIT] LOGIKA SAAT HALAMAN PERTAMA DIBUKA
    // ============================================================
    chrome.storage.local.get('filesForPreview', (result) => {
        initialPlan = result.filesForPreview || [];
        
        if (initialPlan.length === 0) {
            fileListContainer.innerHTML = '<tr class="file-item"><td colspan="3" style="text-align:center; padding: 20px;">Tidak ada data antrian. Silakan kembali ke tab Coretax.</td></tr>';
            return;
        }
        
        // Render Tabel Antrian
        initialPlan.forEach(plan => {
            const row = document.createElement('tr');
            row.id = `item-${plan.invoiceKey}`;
            row.className = 'file-item';
            row.innerHTML = `
                <td class="original-filename" style="color: #999; font-style: italic; font-size: 12px;">(Menunggu file...)</td>
                <td class="arrow-cell">‚û°Ô∏è</td>
                <td class="new-filename">${plan.newFilename}</td>`;
            fileListContainer.appendChild(row);
        });
        
        // Mulai memantau file otomatis
        startUiUpdater();
    });

    // ============================================================
    // [EKSEKUSI] LOGIKA TOMBOL SIMPAN / RENAME
    // ============================================================
    saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        progressContainer.style.display = 'block';
        let successCount = 0;
        const entriesToSave = Object.entries(matchedFiles);

        for (let i = 0; i < entriesToSave.length; i++) {
            const [invoiceKey, fileData] = entriesToSave[i];
            const plan = initialPlan.find(p => p.invoiceKey === invoiceKey);
            if (!plan) continue;

            progressText.textContent = `Memproses ${i + 1} dari ${entriesToSave.length}`;
            currentFileStatus.textContent = `Menyimpan: ${plan.newFilename}`;

            try {
                if (selectedSaveFolderHandle) { 
                    // 1. Simpan ke Folder Pilihan (Direct)
                    const newFileHandle = await selectedSaveFolderHandle.getFileHandle(plan.newFilename, { create: true });
                    const writable = await newFileHandle.createWritable();
                    
                    // Ambil data blob (baik dari upload manual atau fetch URL)
                    const buffer = fileData.isManualUpload 
                        ? await fileData.fileObject.arrayBuffer() 
                        : await (await fetch(fileData.url)).arrayBuffer();
                        
                    await writable.write(buffer);
                    await writable.close();
                } else { 
                    // 2. Simpan ke Downloads (Browser Default)
                    const buffer = fileData.isManualUpload 
                        ? await fileData.fileObject.arrayBuffer() 
                        : await (await fetch(fileData.url)).arrayBuffer();
                        
                    const blob = new Blob([buffer], { type: 'application/pdf' });
                    chrome.downloads.download({
                        url: URL.createObjectURL(blob),
                        filename: plan.newFilename
                    });
                }
                successCount++;
            } catch (error) {
                console.error(`Gagal menyimpan ${plan.newFilename}:`, error);
            }
        }
        
        currentFileStatus.textContent = `‚úÖ Selesai! ${successCount} file berhasil disimpan.`;
        
        // Opsi hapus riwayat (kosmetik di browser)
        if (deleteOriginalFilesCheckbox.checked) {
             // (Opsional) Logika hapus history bisa ditambahkan di sini jika diperlukan API permission
        }

        modalMessage.textContent = `${successCount} dari ${entriesToSave.length} file berhasil disimpan dengan nama baru.`;
        successModal.style.display = 'flex';
        progressContainer.style.display = 'none';
    });
});